<!-- app/templates/dashboard.html -->
<!doctype html>
<html lang="mk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <!-- CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- App styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
  <link rel="stylesheet" href="/static/feed-drawer/feed-drawer.css">
  <link rel="stylesheet" href="/static/feed-notify/feed-notify.css">
  <link rel="stylesheet" href="/static/topbar-user/topbar-user.css">
  <link rel="stylesheet" href="{{ url_for('feed_api.static', filename='feed.css') }}?v=10">

  <!-- (Optional perf) Preload feed modules -->
  <link rel="modulepreload" href="{{ url_for('feed_api.static', filename='feed-utils.js') }}">
  <link rel="modulepreload" href="{{ url_for('feed_api.static', filename='feed-components.js') }}">

  <style>
    /* Visible scrolling behavior (scrollbars hidden) */
    html, body { height: 100%; overflow: hidden; }
    .layout { height: 100%; }
    .main { height: 100%; overflow: hidden; }
    .main__content {
      height: 100%;
      overflow: auto;
      -ms-overflow-style: none;       /* IE/Edge */
      scrollbar-width: none;          /* Firefox */
    }
    .main__content::-webkit-scrollbar { width: 0; height: 0; } /* WebKit */

    .panel-error { padding: 1rem; border: 1px solid #f1aeb5; background:#fff5f5; color:#b02a37; border-radius:.5rem; }
    .sidebar .nav-link.active { background: #f0f3ff; font-weight: 600; }
    .nowrap { white-space: nowrap; }
    .notif-badge { margin-left:.35rem; vertical-align: middle; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ‚ñë‚ñë TOP BAR ‚ñë‚ñë -->
    <header class="topbar" aria-label="–ì–æ—Ä–Ω–∞ –ª–µ–Ω—Ç–∞">
      <div class="topbar__left">
        <strong>–ñ–∏—Ç–æ –ú–∞—Ä–∫–µ—Ç–∏</strong>
      </div>
      <div class="topbar__right d-flex align-items-center gap-2">
        <!-- üîí Logout button (GET /auth/logout) -->
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-light">
          <i class="bi bi-box-arrow-right"></i> –û–¥—ò–∞–≤–∞
        </a>
        {% endif %}

        <!-- Avatar button (opens dropdown) -->
        <button id="TopbarAvatarBtn"
                class="btn p-0 border-0 bg-transparent"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                data-user-id="{{ current_user.id if current_user else '' }}"
                data-fullname="{{ (current_user.first_name ~ ' ' ~ current_user.last_name)|trim if current_user else '–ö–æ—Ä–∏—Å–Ω–∏–∫' }}"
                data-avatar="{{ current_user.avatar_url if current_user and current_user.avatar_url else '/static/img/avatar-placeholder.png' }}"
                data-role="{{ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' if is_admin_like(current_user) else '–ö–æ—Ä–∏—Å–Ω–∏–∫' }}">
          <img src="{{ current_user.avatar_url if current_user and current_user.avatar_url else '/static/img/avatar-placeholder.png' }}"
               alt="–ü—Ä–æ—Ñ–∏–ª" width="32" height="32" class="rounded-circle border"
               data-user-id="{{ current_user.id if current_user else '' }}">
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" aria-label="–ì–ª–∞–≤–Ω–æ –º–µ–Ω–∏">
      <div class="sidebar__header"></div>
      <nav class="sidebar__nav">
        <ul class="nav flex-column">
          <!-- üì∞ Feed -->
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('feed_api.panel') }}"
               data-init="mountFeedPanel"
               data-module="feed">
               –§–∏–¥
            </a>
          </li>

          <!-- üìÖ Calendar (FULL PAGE RELOAD) -->
          <li class="nav-item">
            <a href="{{ url_for('callendar.panel') }}"
               class="nav-link"
               data-module="callendar">
              –ö–∞–ª–µ–Ω–¥–∞—Ä
            </a>
          </li>

          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('drive.panel') }}"
               data-init="mountDrivePanel"
               data-module="drive">
              –î—Ä–∞—ò–≤
            </a>
          </li>

          <!-- üìß Email -->
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('email.provider_select') }}"
               data-module="email">
              –ú–∞–∏–ª
            </a>
          </li>

          <!-- Tickets -->
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('tickets.panel') }}"
               data-init="mountTicketsPanel"
               data-module="tickets">
              –¢–∏–∫–µ—Ç
            </a>
          </li>

          {% if is_admin_like(current_user) or has_permission(current_user, 'users.view') %}
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('users.panel') }}"
               data-init="mountUsersPanel"
               data-module="users">
              –ö–æ—Ä–∏—Å–Ω–∏—Ü–∏
            </a>
          </li>
          {% endif %}

          {% if is_admin_like(current_user) %}
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('departments.panel') }}"
               data-init="mountDepartmentsPanel"
               data-module="departments">
              –û–¥–¥–µ–ª–∏
            </a>
          </li>
          {% endif %}

          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('notes.panel') }}"
               data-init="mountNotesPanel"
               data-module="notes">
              –ë–µ–ª–µ—à–∫–∏
            </a>
          </li>

          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('plan.panel') }}"
               data-init="mountPlanPanel"
               data-module="plan">
              –ü–ª–∞–Ω
            </a>
          </li>

          {% if is_admin_like(current_user) or has_permission(current_user, 'war.view') %}
          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('war.panel') }}"
               data-init="mountWarPanel"
               data-module="war">
              –í–æ—ò–Ω–∞ –∏ –º–∏—Ä
            </a>
          </li>
          {% endif %}

          <li class="nav-item">
            <a href="#"
               class="nav-link"
               data-url="{{ url_for('notifications.index') }}"
               data-init="mountNotificationsPanel"
               data-module="notifications">
              –ò–∑–≤–µ—Å—Ç—É–≤–∞—ö–∞
              <span id="notif-badge" class="notif-badge" style="display:none"></span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- SPA host -->
      <section class="main__content" id="MainContent">
        {% if initial_panel %}
          {{ initial_panel|safe }}
        {% endif %}
      </section>
    </main>
  </div>

  <!-- Vendor JS (CDN) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

  <!-- Global fetch CSRF wrapper -->
  <script>
    (function () {
      const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      const unsafe = new Set(['POST','PUT','PATCH','DELETE']);
      const _fetch = window.fetch;
      window.fetch = function(input, init) {
        init = init || {};
        const method = (init.method || 'GET').toUpperCase();
        if (unsafe.has(method)) {
          init.headers = Object.assign({}, init.headers, { 'X-CSRFToken': token });
        }
        return _fetch(input, init);
      };
      window.CSRF_TOKEN = token;
    })();
  </script>

  <!-- Existing modules -->
  <script src="{{ url_for('users.static', filename='users.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='general.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='agreements.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='vacations.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='sickleave.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='reports.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='uniforms.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='trainings.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='rewards.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='template.js') }}" defer></script>
  <script src="{{ url_for('users.static', filename='mountUsersPanel.js') }}" defer></script>

  <!-- Departments -->
  <script src="{{ url_for('departments.static', filename='departments.js') }}" defer></script>

  <!-- Calendar helper -->
  <script src="{{ url_for('static', filename='js/boot_calendar.js') }}"></script>

  <!-- Feed bridge (if used by Drive) -->
  <script src="/drive/static/feed-bridge.js" defer></script>

  <!-- Other feature modules -->
  <script src="{{ url_for('plan.static', filename='plan.js') }}" defer></script>
  <script src="{{ url_for('notes.static', filename='notes.js') }}" defer></script>
  <script src="{{ url_for('drive.static', filename='drive.js') }}" defer></script>
  <script src="{{ url_for('war.static', filename='war.js') }}" defer></script>
  <script src="{{ url_for('tickets.static', filename='tickets.js') }}" defer></script>
  <script src="{{ url_for('callendar.static', filename='js/views/ticketModal.js') }}" data-exec></script>
  <script src="{{ url_for('callendar.static', filename='js/views/dayListModal.js') }}" data-exec></script>

  <!-- üîî Notifications widget (badge + list logic) -->
  <script defer src="{{ url_for('feed_notify_widget.static', filename='feed-notify.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const div = document.createElement('div');
      div.id = 'feed-notify-root';
      div.dataset.endpoint = '/api/notifications/feed';
      div.dataset.avatar = '/static/img/avatar-placeholder.png';
      div.dataset.badge = '#notif-badge';
      div.style.display = 'none';
      document.body.appendChild(div);
    });
    window.onFeedNotificationClick = (n) => {
      window.dispatchEvent(new CustomEvent('open-feed-post', { detail: { postId: n.post_id }}));
    };
  </script>

  <!-- üéõÔ∏è Post Drawer -->
  <script defer src="{{ url_for('feed_post_drawer.static', filename='feed-drawer.js') }}"></script>

  <!-- ‚ö° Realtime SSE -->
  <script defer src="{{ url_for('realtime.static', filename='realtime.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.Realtime) window.Realtime.connect('/api/realtime/stream');
    });
  </script>

  <!-- üß© FEED: classic comments modal FIRST (exposes window.openCommentsModal) -->
  <script type="module" src="{{ url_for('feed_api.static', filename='comments/open-comments-modal.js') }}?v=1"></script>

  <!-- üß© FEED: split modules (replace old feed-spa.js) -->
  <script type="module" src="{{ url_for('feed_api.static', filename='feed-utils.js') }}" defer></script>
  <script type="module" src="{{ url_for('feed_api.static', filename='feed-components.js') }}" defer></script>
  <script type="module" src="{{ url_for('feed_api.static', filename='feed-main.js') }}" defer></script>

  <!-- ‚úÖ Topbar user dropdown -->
  <script defer src="/static/topbar-user/topbar-user.js"></script>

  <!-- SPA loader (unchanged) -->
  <script>
  (function () {
    var HOST_ID = "MainContent";
    function htmlEscape(s) { s = String(s == null ? "" : s);
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;")
              .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
              .replace(/'/g, "&#39;"); }

    async function fetchPanel(url) {
      var res = await fetch(url, { headers: { "X-Requested-With": "fetch" }, credentials: "same-origin" });
      if (!res.ok) {
        if (res.status === 401) { window.location.href = "/login?next=" + encodeURIComponent(url); return null; }
        if (res.status === 403) {
          var host403 = document.getElementById(HOST_ID);
          if (host403) {
            host403.innerHTML =
              '<div class="panel-error">' +
                '<div class="fw-semibold mb-1">–ü—Ä–∏—Å—Ç–∞–ø –æ–¥–±–∏–µ–Ω</div>' +
                '<div class="small mb-2">–ù–µ–º–∞—Ç–µ –¥–æ–∑–≤–æ–ª–∞ –¥–∞ —ò–∞ –≤–∏–¥–∏—Ç–µ –æ–≤–∞–∞ —Å–µ–∫—Ü–∏—ò–∞.</div>' +
              '</div>';
          }
          return null;
        }
        var err = new Error("HTTP " + res.status);
        err.status = res.status;
        try { err.text = await res.text(); } catch (_e) { err.text = ""; }
        throw err;
      }
      return res.text();
    }

    function showPanelError(url, err) {
      var host = document.getElementById(HOST_ID);
      if (!host) return;
      var msg = (err && (err.message || String(err))) || "–ù–µ–ø–æ–∑–Ω–∞—Ç–∞ –≥—Ä–µ—à–∫–∞";
      host.innerHTML =
        '<div class="panel-error">' +
          '<div class="fw-semibold mb-1">–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –≤—á–∏—Ç–∞ –ø–∞–Ω–µ–ª–æ—Ç.</div>' +
          '<div class="small mb-2"><code>' + htmlEscape(url) + '</code></div>' +
          '<div class="small">' + htmlEscape(msg) + '</div>' +
          '<div class="mt-2">' +
            '<button class="btn btn-sm btn-outline-secondary" id="retryPanel">–û–±–∏–¥–∏ —Å–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>' +
          '</div>' +
        '</div>';
      var btn = document.getElementById("retryPanel");
      if (btn) btn.addEventListener("click", function () {
        loadPanel(url, null, false).catch(function(){});
      });
    }

    function absoluteUrl(url) { var a = document.createElement('a'); a.href = url; return a.href; }

    function executeScripts(container) {
      var ext = Array.prototype.slice.call(container.querySelectorAll('script[src][data-exec]'));
      var already = new Set(Array.prototype.slice.call(document.querySelectorAll('script[src]'))
        .map(function (s) { return absoluteUrl(s.src); }));

      function runInline() {
        var inl = Array.prototype.slice.call(container.querySelectorAll('script:not([src])[data-exec]'));
        inl.forEach(function (old) {
          var n = document.createElement('script');
          if (old.type) n.type = old.type;
          n.textContent = old.textContent || '';
          document.body.appendChild(n);
          n.remove();
          old.remove();
        });
      }

      return ext.reduce(function (p, s) {
        var url = absoluteUrl(s.src);
        if (already.has(url)) { s.remove(); return p; }
        return p.then(function () {
          return new Promise(function (resolve, reject) {
            var n = document.createElement('script');
            n.src = url;
            n.async = false;
            n.onload = function () { s.remove(); resolve(); };
            n.onerror = function () { reject(new Error("Failed to load " + url)); };
            document.head.appendChild(n);
          });
        });
      }, Promise.resolve()).then(runInline);
    }

    async function loadPanel(url, initFnName, push) {
      if (push === void 0) push = true;
      var host = document.getElementById(HOST_ID); if (!host) return;
      var html;
      try { html = await fetchPanel(url); if (html == null) return; }
      catch (err) { console.error("Panel fetch failed:", err); showPanelError(url, err); return; }

      host.innerHTML = html;
      try { await executeScripts(host); } catch (e) { console.warn("Panel scripts execution warning:", e); }

      var selector =
        initFnName === "mountUsersPanel"       ? "#UsersPanel"       :
        initFnName === "mountDepartmentsPanel" ? "#DepartmentsPanel" :
        initFnName === "mountDrivePanel"       ? "#DriveApp"         :
        initFnName === "mountNotesPanel"       ? "#NotesPanel"       :
        initFnName === "mountPlanPanel"        ? "#PlanPanel"        :
        initFnName === "mountWarPanel"         ? "#war-app"          :
        initFnName === "mountTicketsPanel"     ? "#TicketsPanel"     :
        initFnName === "mountEmailPanel"       ? "#EmailPanel"       :
        initFnName === "mountFeedPanel"        ? "#FeedPanel"        :
        null;

      if (!selector || !host.querySelector(selector)) {
        var node = host.querySelector("[id][data-init]") || host.firstElementChild;
        selector = node && node.id ? ("#" + node.id) : "#" + HOST_ID + " > :first-child";
        if (!initFnName) initFnName = node && node.getAttribute ? node.getAttribute("data-init") || "" : "";
      }

      if (initFnName && typeof window[initFnName] === "function") {
        try { window[initFnName](selector); }
        catch (err2) { console.error("Panel init failed:", err2); showPanelError(url, err2); return; }
      }

      try {
        window.dispatchEvent(new CustomEvent("panel:loaded", { detail: { url: url, initFnName: initFnName, host: host } }));
      } catch (_) {}

      if (push) history.pushState({ url: url, initFnName: initFnName }, "", url);
    }

    document.addEventListener("click", function (e) {
      var a = e.target.closest('.sidebar .nav-link[data-url]');
      if (!a) return;
      e.preventDefault();

      Array.prototype.forEach.call(document.querySelectorAll('.sidebar .nav-link.active'), function (el) {
        el.classList.remove('active');
        el.removeAttribute('aria-current');
      });
      a.classList.add('active');
      a.setAttribute('aria-current', 'page');

      var url = a.getAttribute('data-url');
      var initFn = a.getAttribute('data-init') || "";
      loadPanel(url, initFn, true).catch(function (err) {
        console.error("loadPanel error:", err);
        showPanelError(url, err);
      });
    });

    window.addEventListener("popstate", function (ev) {
      var state = ev.state;
      if (!state || !state.url) return;
      loadPanel(state.url, state.initFnName || "", false).catch(function (err) { console.error(err); });
    });

    document.addEventListener("DOMContentLoaded", function () {
      var host = document.getElementById(HOST_ID);
      var hasInjectedPanel = !!(host && host.children && host.children.length > 0);
      var path = window.location.pathname;

      if (path.indexOf("/api/feed") === 0) {
        Array.prototype.forEach.call(document.querySelectorAll('.sidebar .nav-link.active'), function (el) {
          el.classList.remove('active'); el.removeAttribute('aria-current');
        });
        var feedLink = document.querySelector('.sidebar .nav-link[data-module="feed"]');
        if (feedLink) { feedLink.classList.add('active'); feedLink.setAttribute('aria-current','page'); }
        loadPanel(path, "mountFeedPanel", false);
        return;
      }

      var guessedModule =
        path.indexOf("/departments") === 0 ? "departments" :
        path.indexOf("/drive")       === 0 ? "drive"       :
        path.indexOf("/notes")       === 0 ? "notes"       :
        path.indexOf("/plan")        === 0 ? "plan"        :
        path.indexOf("/war")         === 0 ? "war"         :
        path.indexOf("/tickets")     === 0 ? "tickets"     :
        path.indexOf("/email")       === 0 ? "email"       :
        path.indexOf("/callendar")   === 0 ? "callendar"   :
        path.indexOf("/notifications")===0 ? "notifications":
        "users";

      Array.prototype.forEach.call(document.querySelectorAll('.sidebar .nav-link.active'), function (el) {
        el.classList.remove('active');
        el.removeAttribute('aria-current');
      });
      var link = document.querySelector('.sidebar .nav-link[data-module="' + guessedModule + '"]');
      if (link) { link.classList.add('active'); link.setAttribute('aria-current','page'); }

      if (hasInjectedPanel) {
        var node = host.querySelector("[id][data-init]") || host.firstElementChild;
        var initFnName = (node && node.getAttribute) ? (node.getAttribute("data-init") || "") : "";
        var selector = (node && node.id) ? ("#" + node.id) : "#" + HOST_ID + " > :first-child";

        (function executeInline(container){
          var inl = Array.prototype.slice.call(container.querySelectorAll('script:not([src])[data-exec]'));
          inl.forEach(function (s) {
            var n = document.createElement('script');
            if (s.type) n.type = s.type;
            n.textContent = s.textContent || '';
            document.body.appendChild(n);
            n.remove();
            s.remove();
          });
        })(host);

        if (initFnName && typeof window[initFnName] === "function") {
          try { window[initFnName](selector); } catch (err) { console.error("Initial mount failed:", err); }
        }

        try {
          window.dispatchEvent(new CustomEvent("panel:loaded", { detail: { url: path, initFnName: initFnName, host: host } }));
        } catch (_) {}

        return;
      }

      if (guessedModule === "callendar") { return; }
      if (link && link.hasAttribute('data-url')) link.click();
    });
  })();
  </script>
</body>
</html>
