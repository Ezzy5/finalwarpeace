{% block content %}

<div class="container py-4">
  <!-- Header -->
  <div class="d-flex align-items-start justify-content-between mb-3">
    <div>
      <h2 class="mb-1">Ticket #{{ t.id }} â€” {{ t.title }}</h2>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        {% set status_val = (t.status.name if t.status is not string and t.status is not none and t.status.name is defined else t.status|string).upper() %}
        <span class="badge
          {% if status_val == 'COMPLETED' %} text-bg-success
          {% elif status_val == 'IN_PROGRESS' %} text-bg-primary
          {% else %} text-bg-secondary {% endif %}">
          {{ status_val.replace('_', ' ') }}
        </span>

        {% if t.priority %}
          {% set pr = (t.priority.name if t.priority is not string and t.priority is not none and t.priority.name is defined else t.priority|string).upper() %}
          <span class="badge
            {% if pr in ['URGENT','HIGH'] %} text-bg-danger
            {% elif pr == 'MEDIUM' %} text-bg-warning
            {% else %} text-bg-secondary {% endif %}">
            {{ pr.title() }}
          </span>
        {% endif %}

        {% if t.due_date %}
          {% set diff = (t.due_date - today).days %}
          {% if diff == 0 %}
            <span class="badge text-bg-warning">Today</span>
          {% elif diff > 0 %}
            <span class="badge text-bg-secondary">{{ diff }} day{% if diff != 1 %}s{% endif %} left</span>
          {% else %}
            <span class="badge text-bg-danger">Overdue {{ (0 - diff) }} day{% if (0 - diff) != 1 %}s{% endif %}</span>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2">
      {% if can_edit %}
        <a class="btn btn-outline-secondary" href="{{ url_for('tickets.edit', ticket_id=t.id) }}">
          <i class="bi bi-pencil-square"></i> Edit
        </a>
      {% endif %}

      {% if (is_creator or is_assignee) and status_val != 'COMPLETED' %}
        <form method="post" action="{{ url_for('tickets.mark_completed', ticket_id=t.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-success">
            <i class="bi bi-check2-circle"></i> Mark complete
          </button>
        </form>
      {% endif %}

      {% set customer_ok = (t.customer_confirmed or t.customer_satisfied or t.resolved_by_customer or False) %}
      {% if status_val == 'COMPLETED' and not customer_ok %}
        <a class="btn btn-outline-primary" href="{{ url_for('tickets.create', parent_id=t.id) }}">
          <i class="bi bi-node-plus"></i> Create Subticket
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Meta -->
  <div class="text-muted small mb-4">
    <div>
      Created {{ (t.created_at or t.created_at_utc) | default('', true) }} by
      {% set creator = t.creator or t.created_by or None %}
      {% if creator %}
        {{ (creator.first_name ~ ' ' ~ creator.last_name).strip() if (creator.first_name or creator.last_name) else (creator.username or creator.email or ('User #' ~ creator.id)) }}
      {% else %}Unknown{% endif %}
    </div>

    {% if t.assignees %}
      <div>
        Assigned to:
        {% for u in t.assignees %}
          <span class="badge text-bg-light border">
            {{ (u.first_name ~ ' ' ~ u.last_name).strip() if (u.first_name or u.last_name) else (u.username or u.email or ('User #' ~ u.id)) }}
          </span>
        {% endfor %}
      </div>
    {% endif %}

    {% if t.departments %}
      <div>
        Departments:
        {% for d in t.departments %}
          <span class="badge text-bg-light border">{{ d.name or d.title or ('Dept #' ~ d.id) }}</span>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Description -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header"><strong>Description</strong></div>
    <div class="card-body"><div style="white-space: pre-wrap">{{ t.description }}</div></div>
  </div>

  {# ==================== CHECKLIST ==================== #}
  {% set _has_checklists = has_checklists if has_checklists is defined else (checklists and checklists|length) %}
  {% if _has_checklists %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <strong>Checklist</strong>
        {% set total = 0 %}
        {% if sections and sections|length %}
          {% for sec in sections %}
            {% set total = total + ((sec['items'] if sec and 'items' in sec else [])|length) %}
          {% endfor %}
        {% else %}
          {% set total = checklists|length %}
        {% endif %}
        <span class="text-muted small">{{ total }} item{{ '' if total == 1 else 's' }}</span>
      </div>

      <div class="card-body">
        {% if sections and sections|length %}
          <div class="vstack gap-3">
            {% for sec in sections %}
              {% set sec_items = sec['items'] if sec and 'items' in sec else [] %}
              {% if sec_items and sec_items|length %}
                <div class="border rounded-3 p-3">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="fw-semibold">
                      {{ (sec['title'] if 'title' in sec else None) or ('Section ' ~ ((sec['index'] if 'index' in sec else loop.index0) + 1)) }}
                    </div>
                    <span class="text-muted small">#{{ ((sec['index'] if 'index' in sec else loop.index0) + 1) }}</span>
                  </div>

                  <ul class="list-group list-group-flush">
                    {% for ch in sec_items %}
                      <li class="list-group-item d-flex align-items-center">
                        <form method="post"
                              action="{{ url_for('tickets.toggle_checklist', ticket_id=t.id, chk_id=ch.id) }}"
                              class="d-inline-flex align-items-center gap-2 m-0 p-0">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input class="form-check-input" type="checkbox" name="completed"
                                 {% if ch.completed %}checked{% endif %}
                                 {% if not can_comment %}disabled{% endif %}
                                 onchange="this.form.submit()">
                          <span class="{% if ch.completed %}text-decoration-line-through text-muted{% endif %}">{{ ch.title }}</span>
                        </form>
                        {% if ch.position is not none %}
                          <span class="ms-auto text-muted small">#{{ ch.position }}</span>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <ul class="list-group list-group-flush">
            {% for ch in checklists|sort(attribute='position') %}
              <li class="list-group-item d-flex align-items-center">
                <form method="post"
                      action="{{ url_for('tickets.toggle_checklist', ticket_id=t.id, chk_id=ch.id) }}"
                      class="d-inline-flex align-items-center gap-2 m-0 p-0">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input class="form-check-input" type="checkbox" name="completed"
                         {% if ch.completed %}checked{% endif %}
                         {% if not can_comment %}disabled{% endif %}
                         onchange="this.form.submit()">
                  <span class="{% if ch.completed %}text-decoration-line-through text-muted{% endif %}">{{ ch.title }}</span>
                </form>
                {% if ch.position is not none %}
                  <span class="ms-auto text-muted small">#{{ ch.position }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>
  {% endif %}
  {# ================== /CHECKLIST ===================== #}

  <!-- Comments (list) -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header"><strong>Comments</strong></div>
    <div class="card-body">
      {% if comments and comments|length %}
        <div class="d-flex flex-column gap-3">
          {% for c in comments %}
            <div class="border rounded p-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="fw-semibold">
                  {% set a = c.author or c.user or c.created_by or c.creator %}
                  {{ (a.first_name ~ ' ' ~ a.last_name).strip() if a and (a.first_name or a.last_name) else (a.username if a and a.username else (a.email if a and a.email else 'Unknown')) }}
                </div>
                <div class="text-muted small">{{ (c.created_at or c.created_at_utc) | default('', true) }}</div>
              </div>

              {% if c.body %}
                <div class="mb-2" style="white-space: pre-wrap">{{ c.body }}</div>
              {% endif %}

              {% set att_url = None %}
              {% set dl_url  = None %}
              {% set att_path = c.attachment_path or c.attachment_filename %}
              {% if c.attachment_url %}
                {% set att_url = c.attachment_url %}
                {% set dl_url  = c.attachment_url %}
              {% elif att_path %}
                {% if att_path.startswith('tickets/') or '/' in att_path %}
                  {% set att_url = url_for('tickets.preview', path=att_path) %}
                  {% set dl_url  = url_for('tickets.download', path=att_path) %}
                {% else %}
                  {% set att_url = url_for('tickets.attachment', path=att_path) %}
                  {% set dl_url  = att_url %}
                {% endif %}
              {% endif %}

              {% if att_url %}
                {% set lower = att_url|lower %}
                {% set is_img = lower.endswith('.png') or lower.endswith('.jpg') or lower.endswith('.jpeg') or lower.endswith('.gif') or lower.endswith('.webp') %}
                <div class="mt-2 d-flex align-items-center gap-2">
                  {% if is_img %}
                    <a href="{{ att_url }}" target="_blank" class="d-inline-block">
                      <img src="{{ att_url }}" alt="attachment" class="img-fluid rounded border" style="max-height: 300px;">
                    </a>
                  {% else %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ att_url }}" target="_blank">
                      <i class="bi bi-paperclip"></i> View attachment
                    </a>
                  {% endif %}
                  {% if dl_url %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ dl_url }}" target="_blank">
                      <i class="bi bi-download"></i> Download
                    </a>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">No comments yet.</div>
      {% endif %}
    </div>
  </div>

  {# Add Comment form #}
  {% if can_comment %}
    <div class="card mb-4 shadow-sm">
      <div class="card-header"><strong>Add a comment</strong></div>
      <div class="card-body">
        <form action="{{ url_for('tickets.add_comment', ticket_id=t.id) }}" method="post" enctype="multipart/form-data" class="vstack gap-3">
          {{ comment_form.csrf_token }}
          <div>
            <label class="form-label">Comment</label>
            {{ comment_form.body(rows=3, class="form-control", placeholder="Type your comment...") }}
          </div>

          {% if comment_form.attachment is defined %}
            <div>
              <label class="form-label">Attachment (optional)</label>
              {{ comment_form.attachment(class="form-control", accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.doc,.docx,.xls,.xlsx,.txt") }}
              <div class="form-text">Images will preview inline; other files will be downloadable.</div>
            </div>
          {% endif %}

          <div class="d-flex justify-content-end gap-2">
            <a href="{{ url_for('tickets.panel') }}" class="btn btn-outline-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-chat-dots"></i> Add comment
            </button>
          </div>
        </form>
      </div>
    </div>
  {% else %}
    {% if status_val == 'COMPLETED' %}
      <div class="alert alert-info">This ticket is completed; commenting is disabled.</div>
    {% endif %}
  {% endif %}

  <div class="mt-4">
    <a class="btn btn-light" href="{{ url_for('tickets.panel') }}">
      <i class="bi bi-arrow-left"></i> Back to list
    </a>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

{% endblock %}
