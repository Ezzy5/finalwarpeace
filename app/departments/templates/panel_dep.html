<!-- app/departments/templates/panel_dep.html -->
<section class="departments-panel" id="DepartmentsPanel" data-init="mountDepartmentsPanel">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 m-0">Оддели</h2>
    <button type="button" class="btn btn-primary btn-sm" id="btnToggleCreate">+ Нов оддел</button>
  </div>

  <!-- Create Form -->
  <div id="CreateDepartmentWrap" class="card mb-3 d-none">
    <div class="card-body">
      <form id="CreateDepartmentForm" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Име</label>
            <input type="text" name="name" class="form-control" required>
            <div class="text-danger small" data-err="name"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Директор (опционално)</label>
            <select name="manager_id" class="form-select" id="CreateDirectorSelect">
              <option value="">— Нема —</option>
            </select>
            <div class="text-danger small" data-err="manager_id"></div>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button type="submit" class="btn btn-success btn-sm">Зачувај</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCancelCreate">Откажи</button>
        </div>
      </form>
    </div>
  </div>

  <!-- List -->
  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle mb-0">
      <thead>
        <tr>
          <th style="width:60px;">#</th>
          <th>Име</th>
          <th>Директор</th>
          <th class="text-end" style="width: 280px;">Акции</th>
        </tr>
      </thead>
      <tbody id="DepartmentsTable"></tbody>
    </table>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="depEditModal" tabindex="-1" aria-hidden="true" aria-labelledby="depEditModalLabel">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="depEditModalLabel">Уреди оддел</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
        </div>
        <form id="EditDepartmentForm" novalidate>
          <div class="modal-body">
            <input type="hidden" name="id" id="EditDepId">
            <div class="mb-3">
              <label class="form-label">Име</label>
              <input type="text" name="name" id="EditDepName" class="form-control" required>
              <div class="text-danger small" data-err="name"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">Директор</label>
              <select name="manager_id" id="EditDirectorSelect" class="form-select">
                <option value="">— Нема —</option>
              </select>
              <div class="text-danger small" data-err="manager_id"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Зачувај промени</button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Затвори</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Members Modal -->
  <div class="modal fade" id="depMembersModal" tabindex="-1" aria-hidden="true" aria-labelledby="depMembersModalLabel">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="depMembersModalLabel">Членови на одделот</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="MembersDepId">
          <input type="hidden" id="MembersDepName">

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Додади член</label>
              <div class="d-flex gap-2">
                <select id="MembersAddSelect" class="form-select flex-grow-1" style="min-width:280px;"></select>
                <button id="MembersAddBtn" class="btn btn-outline-success ms-auto" type="button" style="min-width:110px;">Додади</button>
              </div>
            </div>
          </div>

          <hr>
          <ul id="MembersList" class="list-group list-group-flush"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Permissions -->
  <div class="modal fade" id="depPermsModal" tabindex="-1" aria-hidden="true" aria-labelledby="depPermsModalLabel">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="depPermsModalLabel">Пермисии на одделот</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
        </div>

        <!--
          Expect the route to pass `groups` like:
          {
            'users': [{code, title, checked}, ...],
            'war':   [{code, title, checked}, ...],
            ...
          }
          If you render this server-side, iterate below with Jinja.
          If you fill via JS, keep the structure/IDs and inject items into #PermsList.
        -->
        <form id="PermsForm" novalidate>
          <div class="modal-body">
            <input type="hidden" id="PermsDepId">

            <!-- Accordion with groups -->
            <div class="accordion" id="PermsAccordion">
              {% if groups %}
                {% for grp, items in groups.items() %}
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="hdr-{{ grp }}">
                      <button class="accordion-button {{ 'collapsed' if not loop.first }}" type="button" data-bs-toggle="collapse" data-bs-target="#col-{{ grp }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="col-{{ grp }}">
                        {{ grp|capitalize }}
                      </button>
                    </h2>
                    <div id="col-{{ grp }}" class="accordion-collapse collapse {{ 'show' if loop.first }}" aria-labelledby="hdr-{{ grp }}" data-bs-parent="#PermsAccordion">
                      <div class="accordion-body">
                        <div class="row g-2">
                          {% for it in items %}
                            <div class="col-md-6">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       id="perm-{{ it.code|replace('.', '-') }}"
                                       name="permission"
                                       value="{{ it.code }}"
                                       data-perm-code="{{ it.code }}"
                                       {% if it.checked %}checked{% endif %}>
                                <label class="form-check-label" for="perm-{{ it.code|replace('.', '-') }}">
                                  {{ it.title }} <small class="text-muted">({{ it.code }})</small>
                                </label>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <!-- If you fill via JS, leave this container empty and target it -->
                <div id="PermsList" class="d-grid gap-2">
                  <div class="text-muted small">Нема пермисии за прикажување.</div>
                </div>
              {% endif %}
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Зачувај</button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Затвори</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Safe inline bootstrapper -->
  <script data-exec>
    (function () {
      if (typeof window.mountDepartmentsPanel !== "function") {
        window.mountDepartmentsPanel = function(){};
      }
    })();
  </script>
</section>
