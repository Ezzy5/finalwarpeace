<!-- app/email/templates/email/message.html -->
<div id="EmailPanel" class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">ðŸ“§ Message</h2>
    {% if account %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('email.mailbox_folder', folder=(selected_folder or 'INBOX'), acc=account.id) }}">
        <i class="bi bi-arrow-left me-1"></i> Back to {{ selected_folder or 'INBOX' }}
      </a>
    {% endif %}
  </div>



  {% if not account %}
    <div class="alert alert-info">No connected account.</div>
  {% elif not message %}
    <div class="alert alert-warning">Message not found.</div>
  {% else %}
  <div class="card shadow-sm">
    <div class="card-body">

      <!-- Header -->
      <div class="mb-2">
        <div class="h5 mb-1">{{ message.headers.subject or "(no subject)" }}</div>
        <div class="small text-muted">
          From: {{ message.headers.from }} Â· To: {{ message.headers.to or 'â€”' }}
          {% if message.headers.cc %} Â· Cc: {{ message.headers.cc }}{% endif %}
          Â· {{ message.headers.date }}
        </div>
      </div>

      <hr>

      <!-- Actions -->
      <div class="mb-3 d-flex gap-2">
        <form class="d-inline mail-action" method="post" action="{{ url_for('email.mail_action_delete') }}" data-mail-action="delete">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="acc" value="{{ account.id }}">
          <input type="hidden" name="folder" value="{{ selected_folder }}">
          <input type="hidden" name="uid" value="{{ msg_uid }}">
          <button class="btn btn-outline-danger btn-sm" type="submit">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>

        <form class="d-inline mail-action" method="post" action="{{ url_for('email.mail_action_archive') }}" data-mail-action="archive">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="acc" value="{{ account.id }}">
          <input type="hidden" name="folder" value="{{ selected_folder }}">
          <input type="hidden" name="uid" value="{{ msg_uid }}">
          <button class="btn btn-outline-secondary btn-sm" type="submit">
            <i class="bi bi-archive"></i> Archive
          </button>
        </form>

        <form class="d-inline mail-action" method="post" action="{{ url_for('email.mail_action_spam') }}" data-mail-action="spam">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="acc" value="{{ account.id }}">
          <input type="hidden" name="folder" value="{{ selected_folder }}">
          <input type="hidden" name="uid" value="{{ msg_uid }}">
          <button class="btn btn-outline-warning btn-sm" type="submit">
            <i class="bi bi-shield-exclamation"></i> Spam
          </button>
        </form>
      </div>

      <!-- Body -->
      {% if message.html %}
        <div class="border p-3 bg-white">
          {{ message.html|safe }}
        </div>
      {% elif message.plain %}
        <pre class="border p-3 mb-0">{{ message.plain }}</pre>
      {% else %}
        <div class="text-muted">No body.</div>
      {% endif %}

      <!-- Attachments -->
      {% if message.attachments and message.attachments|length %}
        <hr>
        <div>
          <div class="fw-semibold mb-1">Attachments</div>
          {% for a in message.attachments %}
            <div class="mb-1">
              <a href="{{ url_for('email.download_attachment',
                                  folder=selected_folder, uid=msg_uid, part_id=a.part_id,
                                  filename=a.filename, acc=account.id) }}">
                <i class="bi bi-paperclip me-1"></i>{{ a.filename }} ({{ a.size }} bytes)
              </a>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- AJAX actions to keep SPA shell -->
<script data-exec>
(function(){
  var forms = document.querySelectorAll('form.mail-action');
  forms.forEach(function(form){
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      var fd = new FormData(form);
      try {
        const res = await fetch(form.action, {
          method: 'POST',
          body: fd,
          headers: { 'X-Requested-With': 'fetch' },
          credentials: 'same-origin'
        });
        let json = {};
        try { json = await res.json(); } catch(_) {}
        if (!res.ok || (json && json.ok === false)) {
          const msg = (json && (json.error || json.message)) || ('HTTP ' + res.status);
          alert('Action failed:\n' + msg);
          return;
        }
        // Success â†’ go to target folder returned by server
        var acc = fd.get('acc');
        var toFolder = (json && json.to) ? json.to : fd.get('folder') || 'INBOX';
        window.location.href = "{{ url_for('email.mailbox_folder', folder='__F__', acc='__A__') }}"
            .replace('__F__', encodeURIComponent(toFolder))
            .replace('__A__', encodeURIComponent(acc));
      } catch (err) {
        console.error('mail action error:', err);
        alert('Action failed:\n' + (err && err.message ? err.message : String(err)));
      }
    }, false);
  });
})();
</script>
