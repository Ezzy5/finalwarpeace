<!-- app/drive/templates/viewer.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ file.original_name or "Viewer" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root {
      --frame-h: calc(100vh - 170px);
    }
    body { background:#f8f9fa; }
    .viewer-wrap { max-width: 1200px; margin: 24px auto; }
    .toolbar { background:#fff; border:1px solid rgba(0,0,0,.12); border-radius: .75rem; padding: .75rem 1rem; }
    .file-meta { color:#6b7280; font-size:.875rem; }
    .frame-shell { background:#fff; border:1px solid rgba(0,0,0,.15); border-radius: .75rem; overflow:hidden; }
    .viewer-frame { width:100%; height: var(--frame-h); border:0; display:block; }
    .media-box { background:#fff; border:1px solid rgba(0,0,0,.15); border-radius:.75rem; padding:.5rem; }
    .img-fit { max-width:100%; height:auto; display:block; margin:auto; }
    .hint { color:#6b7280; font-size:.9rem; }
    @media (max-width: 768px) {
      :root { --frame-h: 70vh; }
    }
  </style>
</head>
<body>
  <div class="viewer-wrap container">
    <!-- Toolbar -->
    <div class="toolbar d-flex align-items-center justify-content-between mb-3">
      <div class="me-3">
        <div class="fw-semibold mb-1">{{ file.original_name }}</div>
        <div class="file-meta">
          {% if preview.mime %}{{ preview.mime }}{% endif %}
          {% if file.size %} · {{ (file.size // 1024) }} KB{% endif %}
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-sm btn-outline-secondary"
           href="{{ url_for('drive.file_download', file_id=file.id, disposition='inline') }}"
           target="_blank" rel="noopener">
          <i class="bi bi-box-arrow-up-right me-1"></i> Open in new tab
        </a>
        <a class="btn btn-sm btn-outline-primary"
           href="{{ url_for('drive.file_download', file_id=file.id, disposition='attachment') }}">
          <i class="bi bi-download me-1"></i> Download
        </a>
        {% if preview.kind == 'pdf' %}
        <button class="btn btn-sm btn-outline-dark" type="button" onclick="printPDF()">
          <i class="bi bi-printer me-1"></i> Print
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Content -->
    {% if preview.kind == 'image' %}
      <div class="media-box">
        <img class="img-fit" src="{{ preview.src }}" alt="{{ file.original_name }}">
      </div>

    {% elif preview.kind == 'video' %}
      <div class="media-box">
        <video class="w-100" style="max-height: var(--frame-h);" controls src="{{ preview.src }}"></video>
      </div>

    {% elif preview.kind == 'audio' %}
      <div class="media-box">
        <audio class="w-100" controls src="{{ preview.src }}"></audio>
      </div>

    {% elif preview.kind == 'pdf' %}
      <!-- Prefer <embed> with explicit type; browsers recognize it better for inline PDF -->
      <div class="frame-shell">
        <embed src="{{ preview.src }}" type="application/pdf" class="viewer-frame" />
      </div>
      <div class="mt-2 hint">
        If the PDF doesn’t render, your browser PDF viewer might be disabled. You can
        <a href="{{ url_for('drive.file_download', file_id=file.id, disposition='inline') }}" target="_blank" rel="noopener">open it in a new tab</a>
        or <a href="{{ url_for('drive.file_download', file_id=file.id, disposition='attachment') }}">download it</a>.
      </div>

    {% elif preview.kind == 'text' %}
      <!-- Raw/text-like content in an iframe to preserve styling/scrolling -->
      <div class="frame-shell">
        <iframe class="viewer-frame" src="{{ preview.src }}" referrerpolicy="no-referrer"></iframe>
      </div>

    {% else %}
      <div class="alert alert-warning">
        <div class="fw-semibold mb-1">Preview not available</div>
        <div class="small mb-2">
          This file type isn’t supported for in-browser preview on this server.
          {% if preview.mime %} ({{ preview.mime }}){% endif %}
        </div>
        <a class="btn btn-primary" href="{{ url_for('drive.file_download', file_id=file.id, disposition='attachment') }}">
          <i class="bi bi-download me-1"></i> Download instead
        </a>
      </div>
    {% endif %}
  </div>

  <script>
    // Print helper for PDFs: open an invisible tab (inline) and trigger print.
    function printPDF() {
      const url = "{{ url_for('drive.file_download', file_id=file.id, disposition='inline') }}";
      const w = window.open(url, "_blank", "noopener");
      if (!w) return;
      const tryPrint = () => {
        try { w.focus(); w.print(); } catch (e) {}
      };
      // Give the viewer a moment to load
      setTimeout(tryPrint, 600);
    }
  </script>
</body>
</html>
