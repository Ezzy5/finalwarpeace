<!-- app/notes/templates/panel_notes.html -->
<div class="container py-3" id="NotesApp" data-init="mountNotesPanel">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Белешки</h4>

    <!-- Visible only if user manages >= 1 department -->
    <div id="NotesDeptSwitcher" class="d-none">
      <label class="form-label me-2 mb-0">Оддел:</label>
      <select class="form-select form-select-sm" style="width:auto" data-notes="dept-select">
        {% for d in (my_depts or []) %}
          <option value="{{ d.id }}">{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <ul class="nav nav-tabs" id="NotesTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-my-today" type="button" role="tab">
        Мои белешки (Денес)
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-my-history" type="button" role="tab">
        Историја
      </button>
    </li>
    <!-- Director-only (real-time) -->
    <li class="nav-item d-none" id="NotesDirectorRTTab" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-director-rt" type="button" role="tab">
        Во живо (Мој Оддел)
      </button>
    </li>
  </ul>

  <div class="tab-content border-start border-end border-bottom p-3">
    <!-- Мои белешки (Денес) -->
    <div class="tab-pane fade show active" id="tab-my-today" role="tabpanel">
      <div class="row g-3 align-items-end">
        <div class="col-6 col-md-2">
          <label class="form-label">Почеток</label>
          <input type="time" class="form-control" data-notes="start">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Крај</label>
          <input type="time" class="form-control" data-notes="end">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Белешка</label>
          <input class="form-control" data-notes="note" placeholder="Кратка белешка (опционално)">
        </div>
        <div class="col-12 col-md-2">
          <button class="btn btn-primary w-100" data-action="add-entry">Додај</button>
        </div>
      </div>

      <hr>

      <div class="d-flex gap-2 flex-wrap">
        <span class="badge bg-secondary" data-notes="today-date"></span>
        <span class="badge bg-info" data-notes="total-today"></span>
      </div>

      <div class="list-group mt-3" id="NotesTodayList"></div>
    </div>

    <!-- Историја (Јас) — with filters -->
    <div class="tab-pane fade" id="tab-my-history" role="tabpanel">
      <div class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="form-label">Од</label>
          <input type="date" class="form-control" data-notes="hist-start">
        </div>
        <div class="col-auto">
          <label class="form-label">До</label>
          <input type="date" class="form-control" data-notes="hist-end">
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" data-action="load-history">Вчитај</button>
        </div>
      </div>
      <div class="mt-3" id="NotesHistory"></div>
    </div>

    <!-- Во живо (Мој Оддел) — Director; full list of all workers today -->
    <div class="tab-pane fade" id="tab-director-rt" role="tabpanel">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="fw-semibold" data-notes="rt-dept-name"></div>
        <!-- dept switcher sits in the header; changing it reloads this list -->
      </div>

      <div class="text-muted small mb-2" data-notes="rt-date"></div>

      <div id="NotesRTAll" class="vstack gap-2"></div>
    </div>
  </div>
</div>

<script src="{{ url_for('notes.static', filename='notes.js') }}" defer data-exec></script>

<!-- Enable Real-Time UI if server injected my_depts -->
<script data-exec>
(function(){
  const hasDepts = {{ 1 if (my_depts|length if my_depts is defined else 0) > 0 else 0 }};
  if (!hasDepts) return;

  // Show Real-Time tab and dept switcher
  const tab = document.getElementById("NotesDirectorRTTab");
  if (tab) tab.classList.remove("d-none");
  const sw = document.getElementById("NotesDeptSwitcher");
  if (sw) sw.classList.remove("d-none");

  // Fill dept selector options
  const options = `
    {% for d in (my_depts or []) %}
      <option value="{{ d.id }}">{{ d.name }}</option>
    {% endfor %}
  `.trim();
  document.querySelectorAll("[data-notes='dept-select']").forEach(s => { s.innerHTML = options; });
})();
</script>
