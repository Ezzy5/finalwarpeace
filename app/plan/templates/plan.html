<!-- app/plan/templates/plan.html -->
<section id="PlanApp" data-role="{{ role|e }}">
  <!-- Director UI -->
  <div id="DirectorTabs" class="{{ 'd-none' if role != 'director' else '' }}">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary" data-action="prev-week">← Претходна</button>
        <button type="button" class="btn btn-outline-secondary" data-action="this-week">Оваа</button>
        <button type="button" class="btn btn-outline-secondary" data-action="next-week">Следна →</button>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input id="UserFilter" type="search" class="form-control" placeholder="Пребарај корисник..." style="min-width:260px;">
      </div>
    </div>

    <div class="row g-3">
      <!-- NEW: Left vertical trash zone -->
      <div class="col-12 col-lg-2">
        <div class="card sticky-lg-top" style="top: 1rem;">
          <div class="card-header">
            <strong>Кошница</strong>
          </div>
          <div class="card-body p-2">
            <div id="TrashZone" class="trash-zone-vertical d-flex align-items-center justify-content-center text-center">
              Повлечи тука<br>за бришење
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Week Grid + Review -->
      <div class="col-12 col-lg-10">
        <div class="card">
          <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
            <strong>План — Недела</strong>
            <div class="text-muted small">
              <span id="WeekRange"></span>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered align-top mb-0" id="WeekGrid">
              <thead class="table-light">
                <tr>
                  <th style="width: 160px;">Корисник</th>
                  <th class="text-center day-head"></th>
                  <th class="text-center day-head"></th>
                  <th class="text-center day-head"></th>
                  <th class="text-center day-head"></th>
                  <th class="text-center day-head"></th>
                  <th class="text-center day-head"></th>
                  <th class="text-center day-head"></th>
                </tr>
              </thead>
              <tbody id="WeekBody">
                <!-- rows created by JS; each cell is a fixed square -->
              </tbody>
            </table>
          </div>

          <div class="card-footer">
            <div class="d-flex flex-wrap gap-2 small">
              <span class="badge priority-low">Low</span>
              <span class="badge priority-medium">Medium</span>
              <span class="badge priority-high">High</span>
              <span class="badge status-assigned">Assigned</span>
              <span class="badge status-in_progress">In Progress</span>
              <span class="badge status-under_review">Under Review</span>
              <span class="badge status-returned">Returned</span>
              <span class="badge status-approved">Approved</span>
              <span class="badge status-completed">Completed</span>
            </div>
          </div>
        </div>

        <!-- Review Queue -->
        <div class="card mt-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Преглед</strong>
            <input id="ReviewSearch" class="form-control form-control-sm" placeholder="Брзо пребарување..." style="max-width:280px;">
          </div>
          <div class="list-group list-group-flush" id="ReviewList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- User UI -->
  <div id="UserKanban" class="{{ 'd-none' if role == 'director' else '' }}">
    <div class="row g-3" id="KanbanCols"></div>
  </div>

  <!-- Hidden placeholder to avoid breaking JS that might read it -->
  <div id="UserList" hidden></div>
</section>

<!-- Create Task Modal -->
<div class="modal fade" id="TaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="TaskForm" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Нова задача</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="TaskOwnerId" name="owner_user_id">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Наслов</label>
            <input class="form-control form-control-lg" name="title" placeholder="Наслов" required>
          </div>
          <div class="col-12">
            <label class="form-label">Опис</label>
            <textarea class="form-control" name="description" rows="5" placeholder="Опис на задачата"></textarea>
          </div>
          <div class="col-6">
            <label class="form-label">Почеток</label>
            <input type="date" class="form-control" name="start_date" required>
          </div>
          <div class="col-6">
            <label class="form-label">Крај</label>
            <input type="date" class="form-control" name="due_date" required>
          </div>
          <div class="col-6">
            <label class="form-label">Приоритет</label>
            <select class="form-select" name="priority">
              <option value="">—</option>
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Датотеки</label>
            <input class="form-control" type="file" name="files[]" multiple>
            <div class="form-text">PDF/Слики/Документи — опционално.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Креирај</button>
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Откажи</button>
      </div>
    </form>
  </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade" id="TaskDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="TDTitle">Задача</h5>
          <div class="small text-muted" id="TDMeta"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Затвори"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="badge me-1" id="TDStatus"></div>
          <div class="badge" id="TDPriority"></div>
        </div>

        <div class="mb-3">
          <h6 class="mb-2">Опис</h6>
          <div id="TDDesc" class="border rounded p-2 bg-light"></div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <h6 class="mb-2">Датотеки</h6>
            <ul id="TaskAttList" class="list-group small"></ul>
          </div>
          <div class="col-12 col-lg-6">
            <h6 class="mb-2">Преглед</h6>
            <div class="ratio ratio-4x3 border rounded bg-light">
              <iframe id="TaskAttPreview" src="" title="Preview" style="border:0;"></iframe>
            </div>
            <div class="mt-2 d-flex gap-2">
              <a id="TaskAttOpen" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">Отвори</a>
              <a id="TaskAttDownload" class="btn btn-sm btn-outline-secondary">Симни</a>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <h6 class="mb-2">Коментари & активност</h6>
          <div id="TDComments" class="list-group"></div>
        </div>

        <div class="mt-3" id="TDUserActions">
          <!-- Filled by JS based on viewer_role + status -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Square calendar cells */
  #WeekGrid tbody td.day-cell {
    min-width: 150px;
    width: 1%;
    height: 140px;
    vertical-align: top;
    position: relative;
    padding: .5rem;
  }
  #WeekGrid thead th.day-head { text-align: center; }
  .cell-plus { position: absolute; top: 6px; right: 6px; }

  /* Task chips */
  .task-chip {
    border-radius: .5rem;
    padding: .35rem .5rem;
    margin-top: 1.6rem;
    font-size: .875rem;
    border: 1px solid #e5e7eb;
    background: #fff;
    cursor: pointer;
  }
  .task-chip .title { font-weight: 600; }
  .task-chip .meta  { font-size: .75rem; color: #6c757d; }

  /* Priority colors */
  .priority-low    { background:#e8f5e9; color:#1b5e20; }
  .priority-medium { background:#fff8e1; color:#8d6e00; }
  .priority-high   { background:#ffebee; color:#b71c1c; }

  /* Status chips */
  .status-assigned      { background:#e7f1ff; color:#0b5ed7; }
  .status-in_progress   { background:#eaf7ea; color:#0a7d17; }
  .status-under_review  { background:#fff3cd; color:#8a6d3b; }
  .status-returned      { background:#fdecea; color:#b02a37; }
  .status-approved      { background:#e2f0ff; color:#0d6efd; }
  .status-completed     { background:#e6e6e6; color:#444; }

  /* Vertical trash zone */
  .trash-zone-vertical {
    border: 2px dashed #dc3545;
    border-radius: .75rem;
    min-height: 70vh;
    width: 100%;
    padding: 1rem;
    color: #dc3545;
    background: #fff;
    user-select: none;
    transition: background .15s ease-in-out, border-color .15s ease-in-out;
  }
  .trash-zone-vertical.dragover {
    background: #fff5f5;
    border-color: #b02a37;
  }
</style>
